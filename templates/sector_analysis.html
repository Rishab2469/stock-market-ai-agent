<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Indian Stock Analysis Agent - Sector Analysis</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .sector-card {
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .sector-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }
        .sector-card.selected {
            border: 3px solid #007bff;
            background: linear-gradient(135deg, #007bff15, #007bff05);
        }
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255,255,255,0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        .recommendation-badge {
            font-size: 0.8rem;
            padding: 0.25rem 0.5rem;
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay" style="display: none;">
        <div class="text-center">
            <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <h4 class="mt-3">Analyzing Sector...</h4>
            <p class="text-muted">This may take 30-60 seconds</p>
        </div>
    </div>

    <div class="container-fluid mt-4">
        <h1 class="text-center mb-2">üáÆüá≥ Indian Stock Analysis Agent</h1>
        <p class="text-center text-muted mb-4">AI-powered sector-wise stock analysis with enhanced news intelligence</p>

        <!-- Sector Comparison Heatmap -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-trophy"></i> Sector Performance Overview</h5>
                        <small class="text-muted">Quick overview of all sectors - Green (Strong Buy) to Red (Sell)</small>
                    </div>
                    <div class="card-body">
                        <!-- Legend -->
                        <div class="row mb-3">
                            <div class="col-12">
                                <div class="d-flex flex-wrap gap-2 justify-content-center">
                                    <span class="badge" style="background-color: #16a34a;">üöÄ Strong Buy</span>
                                    <span class="badge" style="background-color: #22c55e;">üìà Buy</span>
                                    <span class="badge" style="background-color: #84cc16;">üëç Moderate Buy</span>
                                    <span class="badge" style="background-color: #eab308;">‚öñÔ∏è Hold</span>
                                    <span class="badge" style="background-color: #f97316;">üëé Moderate Sell</span>
                                    <span class="badge" style="background-color: #dc2626;">üìâ Sell</span>
                                </div>
                            </div>
                        </div>
                        <!-- Heatmap -->
                        <div id="sectorComparisonHeatmap" class="row g-2">
                            <div class="col-12 text-center text-muted">
                                <i class="fas fa-spinner fa-spin"></i> Loading sector comparison...
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sector Selection -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-industry"></i> Step 1: Select Sector for Analysis</h5>
                        <small class="text-muted">Choose a sector to analyze up to 25 stocks with AI-powered recommendations</small>
                    </div>
                    <div class="card-body">
                        <div class="row g-3" id="sector-grid">
                            <!-- Sector cards will be populated here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Analysis Results -->
        <div id="results-section" style="display: none;">
            <!-- Summary Cards -->
            <div class="row mb-4">
                <div class="col-md-2">
                    <div class="card bg-success text-white text-center">
                        <div class="card-body">
                            <h5 class="card-title"><i class="fas fa-arrow-up"></i> BUY</h5>
                            <h2 id="buy-count">-</h2>
                        </div>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="card bg-warning text-white text-center">
                        <div class="card-body">
                            <h5 class="card-title"><i class="fas fa-minus"></i> HOLD</h5>
                            <h2 id="hold-count">-</h2>
                        </div>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="card bg-danger text-white text-center">
                        <div class="card-body">
                            <h5 class="card-title"><i class="fas fa-arrow-down"></i> SELL</h5>
                            <h2 id="sell-count">-</h2>
                        </div>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="card bg-info text-white text-center">
                        <div class="card-body">
                            <h5 class="card-title"><i class="fas fa-smile"></i> Sentiment</h5>
                            <h2 id="avg-sentiment">-</h2>
                        </div>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="card bg-primary text-white text-center">
                        <div class="card-body">
                            <h5 class="card-title"><i class="fas fa-industry"></i> Sector</h5>
                            <h2 id="current-sector">-</h2>
                        </div>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="card bg-secondary text-white text-center">
                        <div class="card-body">
                            <h5 class="card-title"><i class="fas fa-chart-line"></i> Stocks</h5>
                            <h2 id="total-stocks">-</h2>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recommendations Table -->
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0"><i class="fas fa-table"></i> Stock Recommendations</h5>
                            <div>
                                <button class="btn btn-outline-primary btn-sm" onclick="refreshAnalysis()">
                                    <i class="fas fa-sync-alt"></i> Refresh
                                </button>
                                <button class="btn btn-outline-secondary btn-sm" onclick="selectNewSector()">
                                    <i class="fas fa-arrow-left"></i> Change Sector
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-striped table-hover">
                                    <thead class="table-dark">
                                        <tr>
                                            <th>Stock</th>
                                            <th>Price</th>
                                            <th>Change %</th>
                                            <th>Score</th>
                                            <th>Recommendation</th>
                                            <th>Confidence</th>
                                            <th>Sentiment</th>
                                            <th>Analysis Source</th>
                                            <th>Action</th>
                                        </tr>
                                    </thead>
                                    <tbody id="recommendations-tbody">
                                        <!-- Recommendations will be populated here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Stock Detail Modal -->
    <div class="modal fade" id="stockDetailModal" tabindex="-1" aria-labelledby="stockDetailModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="stockDetailModalLabel">
                        <span id="modal-stock-symbol">Stock</span> - Detailed Analysis
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- Loading State -->
                    <div id="modal-loading" class="text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Loading detailed analysis...</p>
                    </div>

                    <!-- Stock Details Content -->
                    <div id="modal-content" style="display: none;">
                        <!-- Stock Header -->
                        <div class="row mb-4">
                            <div class="col-md-8">
                                <h3 id="detail-stock-name">Stock Name</h3>
                                <p class="text-muted mb-2">
                                    <span id="detail-sector">Sector</span> |
                                    <span id="detail-industry">Industry</span>
                                </p>
                                <div class="d-flex align-items-center gap-3">
                                    <h4 class="mb-0">‚Çπ<span id="detail-price">0.00</span></h4>
                                    <span id="detail-change" class="badge fs-6">0.00%</span>
                                    <span id="detail-recommendation" class="badge fs-6">HOLD</span>
                                </div>
                            </div>
                            <div class="col-md-4 text-end">
                                <div class="card bg-light">
                                    <div class="card-body text-center">
                                        <h5 class="card-title">AI Score</h5>
                                        <h2 id="detail-score" class="text-primary">0</h2>
                                        <p class="card-text">
                                            <span id="detail-confidence" class="badge bg-info">Low</span>
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Key Metrics -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h5><i class="fas fa-chart-bar"></i> Key Metrics</h5>
                                <div class="row">
                                    <div class="col-md-3">
                                        <div class="card text-center">
                                            <div class="card-body">
                                                <h6 class="card-title">Market Cap</h6>
                                                <h5 id="detail-market-cap">‚Çπ0Cr</h5>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="card text-center">
                                            <div class="card-body">
                                                <h6 class="card-title">P/E Ratio</h6>
                                                <h5 id="detail-pe-ratio">N/A</h5>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="card text-center">
                                            <div class="card-body">
                                                <h6 class="card-title">RSI</h6>
                                                <h5 id="detail-rsi">50</h5>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="card text-center">
                                            <div class="card-body">
                                                <h6 class="card-title">Beta</h6>
                                                <h5 id="detail-beta">N/A</h5>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Technical Analysis -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <h5><i class="fas fa-chart-line"></i> Technical Analysis</h5>
                                <div class="card">
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-6">
                                                <strong>20-Day MA:</strong><br>
                                                ‚Çπ<span id="detail-ma20">0.00</span>
                                            </div>
                                            <div class="col-6">
                                                <strong>50-Day MA:</strong><br>
                                                ‚Çπ<span id="detail-ma50">0.00</span>
                                            </div>
                                        </div>
                                        <hr>
                                        <div class="row">
                                            <div class="col-6">
                                                <strong>Volatility:</strong><br>
                                                <span id="detail-volatility">0.00%</span>
                                            </div>
                                            <div class="col-6">
                                                <strong>Volume Ratio:</strong><br>
                                                <span id="detail-volume-ratio">1.00x</span>
                                            </div>
                                        </div>
                                        <hr>
                                        <div class="row">
                                            <div class="col-12">
                                                <strong>Target Price:</strong><br>
                                                ‚Çπ<span id="detail-target-price">N/A</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <h5><i class="fas fa-newspaper"></i> Sentiment Analysis</h5>
                                <div class="card">
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-6">
                                                <strong>Sentiment Score:</strong><br>
                                                <span id="detail-sentiment-score" class="fs-4">0.000</span>
                                            </div>
                                            <div class="col-6">
                                                <strong>Sentiment:</strong><br>
                                                <span id="detail-sentiment" class="badge fs-6">Neutral</span>
                                            </div>
                                        </div>
                                        <hr>
                                        <div class="row">
                                            <div class="col-12">
                                                <strong>News Articles:</strong><br>
                                                <span id="detail-article-count">0</span> articles analyzed
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- RSI Analysis -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <h5><i class="fas fa-chart-area"></i> RSI Analysis</h5>
                                <div class="card">
                                    <div class="card-body">
                                        <div class="text-center mb-3">
                                            <h3 id="detail-rsi-value" class="text-primary">50</h3>
                                            <span id="detail-rsi-status" class="badge bg-warning">Neutral</span>
                                        </div>
                                        <div class="progress mb-2" style="height: 20px;">
                                            <div id="detail-rsi-bar" class="progress-bar" role="progressbar" style="width: 50%"></div>
                                        </div>
                                        <div class="row text-center small">
                                            <div class="col-4">
                                                <strong>Oversold</strong><br>
                                                <span class="text-success">< 30</span>
                                            </div>
                                            <div class="col-4">
                                                <strong>Neutral</strong><br>
                                                <span class="text-warning">30-70</span>
                                            </div>
                                            <div class="col-4">
                                                <strong>Overbought</strong><br>
                                                <span class="text-danger">> 70</span>
                                            </div>
                                        </div>
                                        <hr>
                                        <p id="detail-rsi-interpretation" class="small mb-0">RSI interpretation will appear here</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <h5><i class="fas fa-users"></i> Promoter Holdings</h5>
                                <div class="card">
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-6">
                                                <strong>Current Holding:</strong><br>
                                                <h4 id="detail-promoter-holding" class="text-primary">N/A</h4>
                                            </div>
                                            <div class="col-6">
                                                <strong>Trend:</strong><br>
                                                <span id="detail-promoter-trend" class="badge bg-secondary">Stable</span>
                                            </div>
                                        </div>
                                        <hr>
                                        <div class="row">
                                            <div class="col-12">
                                                <strong>FII/DII Holdings:</strong><br>
                                                <small>FII: <span id="detail-fii-holding">N/A</span></small><br>
                                                <small>DII: <span id="detail-dii-holding">N/A</span></small>
                                            </div>
                                        </div>
                                        <hr>
                                        <p id="detail-holding-analysis" class="small mb-0">Holding analysis will appear here</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- News Analysis -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h5><i class="fas fa-newspaper"></i> News Analysis & Market Impact</h5>
                                <div class="card">
                                    <div class="card-body">
                                        <div class="row mb-3">
                                            <div class="col-md-4">
                                                <div class="text-center">
                                                    <h6>News Sentiment</h6>
                                                    <h3 id="detail-news-sentiment-score" class="text-info">0.000</h3>
                                                    <span id="detail-news-sentiment-label" class="badge bg-secondary">Neutral</span>
                                                </div>
                                            </div>
                                            <div class="col-md-4">
                                                <div class="text-center">
                                                    <h6>Articles Analyzed</h6>
                                                    <h3 id="detail-news-count" class="text-primary">0</h3>
                                                    <small class="text-muted">Last 7 days</small>
                                                </div>
                                            </div>
                                            <div class="col-md-4">
                                                <div class="text-center">
                                                    <h6>Market Impact</h6>
                                                    <span id="detail-market-impact" class="badge bg-warning fs-6">Medium</span>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="row">
                                            <div class="col-12">
                                                <h6>Recent News Summary:</h6>
                                                <div id="detail-news-summary" class="border rounded p-3 bg-light">
                                                    <p class="mb-0">Loading news analysis...</p>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="row mt-3">
                                            <div class="col-md-6">
                                                <h6>Positive Factors:</h6>
                                                <ul id="detail-positive-factors" class="list-unstyled">
                                                    <li class="text-success"><i class="fas fa-plus-circle"></i> Loading...</li>
                                                </ul>
                                            </div>
                                            <div class="col-md-6">
                                                <h6>Risk Factors:</h6>
                                                <ul id="detail-risk-factors" class="list-unstyled">
                                                    <li class="text-danger"><i class="fas fa-exclamation-triangle"></i> Loading...</li>
                                                </ul>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Corporate Actions -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <h5><i class="fas fa-calendar-alt"></i> Corporate Actions</h5>
                                <div class="card">
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-12">
                                                <strong>Recent Dividends:</strong>
                                                <div id="detail-dividend-info" class="mt-2">
                                                    <div class="d-flex justify-content-between">
                                                        <span>Dividend Yield:</span>
                                                        <span id="detail-dividend-yield" class="fw-bold">N/A</span>
                                                    </div>
                                                    <div class="d-flex justify-content-between">
                                                        <span>Last Dividend:</span>
                                                        <span id="detail-last-dividend">N/A</span>
                                                    </div>
                                                    <div class="d-flex justify-content-between">
                                                        <span>Ex-Date:</span>
                                                        <span id="detail-ex-date">N/A</span>
                                                    </div>
                                                </div>
                                                <hr>
                                                <strong>Other Actions:</strong>
                                                <div id="detail-other-actions" class="mt-2">
                                                    <small class="text-muted">Stock splits, bonuses, rights issues will appear here</small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <h5><i class="fas fa-chart-pie"></i> Financial Highlights</h5>
                                <div class="card">
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-6">
                                                <strong>Revenue Growth:</strong><br>
                                                <span id="detail-revenue-growth" class="text-primary">N/A</span>
                                            </div>
                                            <div class="col-6">
                                                <strong>Profit Margin:</strong><br>
                                                <span id="detail-profit-margin" class="text-success">N/A</span>
                                            </div>
                                        </div>
                                        <hr>
                                        <div class="row">
                                            <div class="col-6">
                                                <strong>ROE:</strong><br>
                                                <span id="detail-roe">N/A</span>
                                            </div>
                                            <div class="col-6">
                                                <strong>Debt/Equity:</strong><br>
                                                <span id="detail-debt-equity">N/A</span>
                                            </div>
                                        </div>
                                        <hr>
                                        <div class="row">
                                            <div class="col-12">
                                                <strong>Book Value:</strong><br>
                                                ‚Çπ<span id="detail-book-value">N/A</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Hybrid Analysis Breakdown -->
                        <div class="row mb-4" id="hybrid-analysis-section" style="display: none;">
                            <div class="col-12">
                                <h5><i class="fas fa-brain"></i> Hybrid AI + Sentiment Analysis Breakdown</h5>
                                <div class="card border-primary">
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-md-4">
                                                <div class="text-center">
                                                    <h6>AI Base Score</h6>
                                                    <h3 id="detail-ai-base-score" class="text-primary">0</h3>
                                                    <small class="text-muted">70% weight</small>
                                                </div>
                                            </div>
                                            <div class="col-md-4">
                                                <div class="text-center">
                                                    <h6>Sentiment Boost</h6>
                                                    <h3 id="detail-sentiment-boost" class="text-info">0</h3>
                                                    <small class="text-muted">30% weight</small>
                                                </div>
                                            </div>
                                            <div class="col-md-4">
                                                <div class="text-center">
                                                    <h6>Final Hybrid Score</h6>
                                                    <h3 id="detail-hybrid-final" class="text-success">0</h3>
                                                    <small class="text-muted">Combined result</small>
                                                </div>
                                            </div>
                                        </div>
                                        <hr>
                                        <div class="row">
                                            <div class="col-12">
                                                <strong>Fusion Method:</strong>
                                                <span id="detail-fusion-method" class="badge bg-success">AI + Sentiment Fusion</span>
                                                <br><br>
                                                <strong>Analysis Components:</strong>
                                                <ul class="list-unstyled">
                                                    <li><i class="fas fa-robot text-primary"></i> <strong>AI Analysis (70%):</strong> Professional reasoning, contextual understanding</li>
                                                    <li><i class="fas fa-newspaper text-info"></i> <strong>Sentiment Analysis (30%):</strong> Market mood, news impact</li>
                                                    <li><i class="fas fa-plus text-success"></i> <strong>Enhancement Modifiers:</strong> News quality, technical alignment</li>
                                                </ul>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- AI Analysis -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h5><i class="fas fa-robot"></i> AI Analysis & Investment Thesis</h5>
                                <div class="card">
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-md-8">
                                                <strong>Investment Thesis:</strong>
                                                <p id="detail-reasoning" class="mt-2">No analysis available</p>

                                                <strong>Key Catalysts:</strong>
                                                <ul id="detail-catalysts" class="mt-2">
                                                    <li>Loading catalysts...</li>
                                                </ul>

                                                <strong>Risks to Watch:</strong>
                                                <ul id="detail-risks" class="mt-2">
                                                    <li>Loading risks...</li>
                                                </ul>
                                            </div>
                                            <div class="col-md-4">
                                                <div class="text-center mb-3">
                                                    <strong>Overall Rating:</strong><br>
                                                    <span id="detail-overall-rating" class="badge bg-primary fs-5">HOLD</span>
                                                </div>

                                                <strong>Analysis Source:</strong><br>
                                                <span id="detail-analysis-source" class="badge bg-success fs-6">AI + Sentiment</span>
                                                <br><br>

                                                <strong>Risk Level:</strong><br>
                                                <span id="detail-risk-level" class="badge fs-6 bg-warning">Medium</span>
                                                <br><br>

                                                <strong>Time Horizon:</strong><br>
                                                <span id="detail-time-horizon" class="badge bg-info">Medium Term</span>
                                                <br><br>

                                                <strong>Last Updated:</strong><br>
                                                <small id="detail-last-updated" class="text-muted">N/A</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div class="row">
                            <div class="col-12 text-center">
                                <button class="btn btn-primary me-2" onclick="openYahooFinance()">
                                    <i class="fas fa-external-link-alt"></i> View on Yahoo Finance
                                </button>
                                <button class="btn btn-outline-secondary me-2" onclick="refreshStockData()">
                                    <i class="fas fa-sync-alt"></i> Refresh Data
                                </button>
                                <button class="btn btn-outline-info" onclick="exportStockData()">
                                    <i class="fas fa-download"></i> Export Data
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentSector = null;
        let analysisData = null;

        // Sector information
        const sectors = {
            'BANKING': {
                name: 'Banking',
                icon: 'üè¶',
                description: 'Banks, PSU banks, small finance banks',
                color: '#28a745',
                stocks: 25
            },
            'INFORMATION_TECHNOLOGY': {
                name: 'Information Technology',
                icon: 'üíª',
                description: 'IT services, software, tech companies',
                color: '#007bff',
                stocks: 25
            },
            'ENERGY_OIL_GAS': {
                name: 'Energy & Oil/Gas',
                icon: '‚ö°',
                description: 'Oil, gas, power, renewable energy',
                color: '#ffc107',
                stocks: 25
            },
            'FMCG_CONSUMER': {
                name: 'FMCG & Consumer',
                icon: 'üõí',
                description: 'FMCG, food, beverages, personal care',
                color: '#17a2b8',
                stocks: 25
            },
            'AUTOMOTIVE': {
                name: 'Automotive',
                icon: 'üöó',
                description: 'Auto manufacturers, components, EVs',
                color: '#6f42c1',
                stocks: 25
            },
            'PHARMACEUTICALS': {
                name: 'Pharmaceuticals',
                icon: 'üíä',
                description: 'Pharma, healthcare, diagnostics',
                color: '#e83e8c',
                stocks: 25
            },
            'FINANCE_NBFC': {
                name: 'Finance & NBFC',
                icon: 'üí∞',
                description: 'NBFCs, insurance, asset management',
                color: '#fd7e14',
                stocks: 25
            },
            'METALS_MINING': {
                name: 'Metals & Mining',
                icon: 'üè≠',
                description: 'Steel, aluminum, coal, mining',
                color: '#6c757d',
                stocks: 25
            },
            'INFRASTRUCTURE': {
                name: 'Infrastructure',
                icon: 'üèóÔ∏è',
                description: 'Construction, ports, real estate',
                color: '#20c997',
                stocks: 25
            },
            'CEMENT': {
                name: 'Cement',
                icon: 'üß±',
                description: 'Cement, building materials',
                color: '#dc3545',
                stocks: 25
            },
            'DEFENCE': {
                name: 'Defence',
                icon: 'üõ°Ô∏è',
                description: 'Defence PSUs, aerospace, shipbuilding',
                color: '#8b5cf6',
                stocks: 20
            }
        };

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            loadSectorGrid();
            loadSectorComparisonHeatmap();
        });

        function loadSectorGrid() {
            const grid = document.getElementById('sector-grid');
            grid.innerHTML = '';

            Object.keys(sectors).forEach(sectorKey => {
                const sector = sectors[sectorKey];
                const col = document.createElement('div');
                col.className = 'col-lg-2 col-md-3 col-sm-4 col-6';

                col.innerHTML = `
                    <div class="card sector-card h-100" onclick="selectSector('${sectorKey}')"
                         style="border-color: ${sector.color};">
                        <div class="card-body text-center">
                            <div class="fs-1 mb-2">${sector.icon}</div>
                            <h6 class="card-title">${sector.name}</h6>
                            <p class="card-text small text-muted">${sector.description}</p>
                            <span class="badge" style="background-color: ${sector.color};">Up to ${sector.stocks} Stocks</span>
                        </div>
                    </div>
                `;

                grid.appendChild(col);
            });
        }

        function selectSector(sectorKey) {
            console.log('Selecting sector:', sectorKey);

            // Update UI - remove selection from all cards
            document.querySelectorAll('.sector-card').forEach(card => {
                card.classList.remove('selected');
            });

            // Add selection to the correct card
            if (typeof event !== 'undefined' && event.currentTarget) {
                // Called from click event
                event.currentTarget.classList.add('selected');
            } else {
                // Called programmatically - find the correct card
                const sectorCards = document.querySelectorAll('.sector-card');
                sectorCards.forEach(card => {
                    const cardOnClick = card.getAttribute('onclick');
                    if (cardOnClick && cardOnClick.includes(`'${sectorKey}'`)) {
                        card.classList.add('selected');
                    }
                });
            }

            currentSector = sectorKey;

            // Start analysis
            analyzeSector(sectorKey);
        }

        function analyzeSector(sectorKey) {
            if (!sectorKey) return;

            // Show loading
            document.getElementById('loading-overlay').style.display = 'flex';

            // Hide results
            document.getElementById('results-section').style.display = 'none';

            // Make API call
            fetch(`/api/recommendations?sector=${sectorKey}&refresh=true`)
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        analysisData = data;
                        displayResults(data);
                    } else {
                        alert('Error: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error analyzing sector: ' + error.message);
                })
                .finally(() => {
                    document.getElementById('loading-overlay').style.display = 'none';
                });
        }

        function displayResults(data) {
            // Update summary cards
            const recommendations = data.data;
            const buyCount = recommendations.filter(r => r.recommendation === 'BUY').length;
            const holdCount = recommendations.filter(r => r.recommendation === 'HOLD').length;
            const sellCount = recommendations.filter(r => r.recommendation === 'SELL').length;
            const avgSentiment = (recommendations.reduce((sum, r) => sum + r.sentiment_score, 0) / recommendations.length).toFixed(2);

            document.getElementById('buy-count').textContent = buyCount;
            document.getElementById('hold-count').textContent = holdCount;
            document.getElementById('sell-count').textContent = sellCount;
            document.getElementById('avg-sentiment').textContent = avgSentiment;
            document.getElementById('current-sector').textContent = data.sector_display;
            document.getElementById('total-stocks').textContent = recommendations.length;

            // Update table
            const tbody = document.getElementById('recommendations-tbody');
            tbody.innerHTML = '';

            recommendations.forEach(stock => {
                const row = document.createElement('tr');

                // Recommendation badge color
                let badgeClass = 'bg-secondary';
                if (stock.recommendation === 'BUY') badgeClass = 'bg-success';
                else if (stock.recommendation === 'SELL') badgeClass = 'bg-danger';
                else if (stock.recommendation === 'HOLD') badgeClass = 'bg-warning';

                // Sentiment color
                let sentimentClass = 'text-muted';
                if (stock.sentiment_score > 0.1) sentimentClass = 'text-success';
                else if (stock.sentiment_score < -0.1) sentimentClass = 'text-danger';

                // Analysis source badge
                let analysisSourceClass = 'bg-secondary';
                let analysisSourceText = stock.analysis_source || 'Rule-based';
                if (analysisSourceText.includes('AI + Sentiment')) {
                    analysisSourceClass = 'bg-success';
                    analysisSourceText = 'AI+Sentiment';
                } else if (analysisSourceText.includes('AI')) {
                    analysisSourceClass = 'bg-primary';
                    analysisSourceText = 'AI';
                } else {
                    analysisSourceText = 'Rule-based';
                }

                row.innerHTML = `
                    <td>
                        <strong style="cursor: pointer; color: #007bff;" onclick="showStockDetails('${stock.symbol_display}')">
                            ${stock.symbol_display}
                        </strong>
                    </td>
                    <td>‚Çπ${stock.current_price}</td>
                    <td class="${stock.price_change >= 0 ? 'text-success' : 'text-danger'}">
                        ${stock.price_change >= 0 ? '+' : ''}${stock.price_change}%
                    </td>
                    <td><strong>${stock.composite_score}</strong></td>
                    <td><span class="badge ${badgeClass}">${stock.recommendation}</span></td>
                    <td><span class="badge bg-info">${stock.confidence}</span></td>
                    <td class="${sentimentClass}">${stock.sentiment_score}</td>
                    <td><span class="badge ${analysisSourceClass}" style="font-size: 0.7rem;">${analysisSourceText}</span></td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="showStockDetails('${stock.symbol_display}')">
                            <i class="fas fa-eye"></i> Details
                        </button>
                    </td>
                `;

                tbody.appendChild(row);
            });

            // Show results
            document.getElementById('results-section').style.display = 'block';

            // Scroll to results
            document.getElementById('results-section').scrollIntoView({
                behavior: 'smooth',
                block: 'start'
            });
        }

        function refreshAnalysis() {
            if (currentSector) {
                analyzeSector(currentSector);
            }
        }

        function selectNewSector() {
            // Clear selection
            document.querySelectorAll('.sector-card').forEach(card => {
                card.classList.remove('selected');
            });

            currentSector = null;
            analysisData = null;

            // Hide results
            document.getElementById('results-section').style.display = 'none';

            // Scroll to top
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function loadSectorComparisonHeatmap() {
            fetch('/api/sector-comparison-heatmap')
                .then(r => r.json())
                .then(data => {
                    if (data.status === 'success') {
                        updateSectorComparisonHeatmap(data.sectors);
                    } else {
                        console.error('Error loading sector comparison:', data.message);
                        document.getElementById('sectorComparisonHeatmap').innerHTML =
                            '<div class="col-12 text-center text-muted">Sector comparison unavailable</div>';
                    }
                })
                .catch(error => {
                    console.error('Error loading sector comparison:', error);
                    document.getElementById('sectorComparisonHeatmap').innerHTML =
                        '<div class="col-12 text-center text-muted">Sector comparison unavailable</div>';
                });
        }

        function updateSectorComparisonHeatmap(sectors) {
            const container = document.getElementById('sectorComparisonHeatmap');
            container.innerHTML = '';

            if (!sectors || sectors.length === 0) {
                container.innerHTML = '<div class="col-12 text-center text-muted">No sector data available</div>';
                return;
            }

            sectors.forEach((sector, index) => {
                const col = document.createElement('div');
                col.className = 'col-lg-2 col-md-3 col-sm-4 col-6 mb-2';

                // Create ranking badge
                let rankBadge = '';
                if (index === 0) rankBadge = 'ü•á';
                else if (index === 1) rankBadge = 'ü•à';
                else if (index === 2) rankBadge = 'ü•â';
                else rankBadge = `#${index + 1}`;

                col.innerHTML = `
                    <div class="card h-100 sector-comparison-card"
                         style="cursor: pointer; transition: all 0.3s; border: 2px solid ${sector.color}; background: linear-gradient(135deg, ${sector.color}15, ${sector.color}05);"
                         onclick="selectSectorFromHeatmap('${sector.sector}')"
                         onmouseover="this.style.transform='scale(1.05)'; this.style.boxShadow='0 8px 25px rgba(0,0,0,0.15)'"
                         onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='none'">
                        <div class="card-body p-2 text-center">
                            <!-- Ranking Badge -->
                            <div class="position-absolute top-0 start-0 m-1">
                                <span class="badge bg-dark" style="font-size: 0.6rem;">${rankBadge}</span>
                            </div>

                            <!-- Sector Icon and Category -->
                            <div class="fs-4 mb-1">${sector.icon}</div>

                            <!-- Sector Name -->
                            <h6 class="card-title mb-1" style="font-size: 0.7rem; font-weight: bold;">
                                ${sector.display_name}
                            </h6>

                            <!-- Sector Strength Score -->
                            <div class="mb-1">
                                <div class="fs-6 fw-bold" style="color: ${sector.color};">
                                    ${sector.sector_strength}
                                </div>
                                <small class="text-muted" style="font-size: 0.6rem;">Score</small>
                            </div>

                            <!-- Category Label -->
                            <div class="mb-1">
                                <span class="badge" style="background-color: ${sector.color}; font-size: 0.6rem;">
                                    ${sector.label}
                                </span>
                            </div>
                        </div>
                    </div>
                `;

                container.appendChild(col);
            });
        }

        function selectSectorFromHeatmap(sectorKey) {
            console.log('Heatmap sector clicked:', sectorKey);

            // Check if the sector exists in our sectors object
            if (!sectors[sectorKey]) {
                console.error('Sector not found in sectors object:', sectorKey);
                alert(`Sector ${sectorKey} not found. Please select from the sector grid below.`);
                return;
            }

            // Scroll to sector selection
            document.getElementById('sector-grid').scrollIntoView({
                behavior: 'smooth',
                block: 'start'
            });

            // Select the sector after scrolling
            setTimeout(() => {
                // Find the sector card and trigger click
                const sectorCards = document.querySelectorAll('.sector-card');
                let found = false;

                sectorCards.forEach(card => {
                    const cardOnClick = card.getAttribute('onclick');
                    if (cardOnClick && cardOnClick.includes(`'${sectorKey}'`)) {
                        card.click();
                        found = true;
                    }
                });

                if (!found) {
                    console.error('Could not find sector card for:', sectorKey);
                    // Fallback: call selectSector directly
                    selectSector(sectorKey);
                }
            }, 500);
        }

        // Stock Detail Modal Functions
        let currentStockData = null;

        function showStockDetails(stockSymbol) {
            // Find the stock data from current analysis
            if (!analysisData || !analysisData.data) {
                alert('No analysis data available');
                return;
            }

            const stock = analysisData.data.find(s => s.symbol_display === stockSymbol);
            if (!stock) {
                alert('Stock data not found');
                return;
            }

            currentStockData = stock;

            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('stockDetailModal'));

            // Show loading state
            document.getElementById('modal-loading').style.display = 'block';
            document.getElementById('modal-content').style.display = 'none';

            // Update modal title
            document.getElementById('modal-stock-symbol').textContent = stockSymbol;

            modal.show();

            // Simulate loading and populate data
            setTimeout(() => {
                populateStockDetails(stock);
                document.getElementById('modal-loading').style.display = 'none';
                document.getElementById('modal-content').style.display = 'block';
            }, 500);
        }

        function populateStockDetails(stock) {
            // Stock Header
            document.getElementById('detail-stock-name').textContent = stock.symbol_display;
            document.getElementById('detail-sector').textContent = stock.sector || 'Unknown';
            document.getElementById('detail-industry').textContent = 'Indian Stock Market';
            document.getElementById('detail-price').textContent = stock.current_price;

            // Price change badge
            const changeElement = document.getElementById('detail-change');
            changeElement.textContent = `${stock.price_change >= 0 ? '+' : ''}${stock.price_change}%`;
            changeElement.className = `badge fs-6 ${stock.price_change >= 0 ? 'bg-success' : 'bg-danger'}`;

            // Recommendation badge
            const recElement = document.getElementById('detail-recommendation');
            recElement.textContent = stock.recommendation;
            let recClass = 'bg-secondary';
            if (stock.recommendation === 'BUY') recClass = 'bg-success';
            else if (stock.recommendation === 'SELL') recClass = 'bg-danger';
            else if (stock.recommendation === 'HOLD') recClass = 'bg-warning';
            recElement.className = `badge fs-6 ${recClass}`;

            // AI Score and Confidence
            document.getElementById('detail-score').textContent = stock.composite_score;
            document.getElementById('detail-confidence').textContent = stock.confidence;

            // Key Metrics
            document.getElementById('detail-market-cap').textContent = stock.market_cap;
            document.getElementById('detail-pe-ratio').textContent = stock.pe_ratio || 'N/A';
            document.getElementById('detail-rsi').textContent = stock.rsi || '50';
            document.getElementById('detail-beta').textContent = stock.beta || 'N/A';

            // Technical Analysis with fallback values
            const ma20 = stock.ma_20 && stock.ma_20 > 0 ? stock.ma_20 : stock.current_price;
            const ma50 = stock.ma_50 && stock.ma_50 > 0 ? stock.ma_50 : stock.current_price;
            document.getElementById('detail-ma20').textContent = ma20.toFixed(2);
            document.getElementById('detail-ma50').textContent = ma50.toFixed(2);
            document.getElementById('detail-volatility').textContent = `${(stock.volatility * 100 || 0).toFixed(2)}%`;
            document.getElementById('detail-volume-ratio').textContent = `${stock.volume_ratio || 1.00}x`;
            document.getElementById('detail-target-price').textContent = stock.target_price || 'N/A';

            // RSI Analysis
            populateRSIAnalysis(stock.rsi || 50);

            // Promoter Holdings (simulated data)
            populatePromoterHoldings(stock);

            // News Analysis
            populateNewsAnalysis(stock);

            // Corporate Actions
            populateCorporateActions(stock);

            // Financial Highlights
            populateFinancialHighlights(stock);

            // Enhanced AI Analysis
            populateEnhancedAIAnalysis(stock);

            // Hybrid Analysis Details
            populateHybridAnalysisDetails(stock);

            // Sentiment Analysis
            document.getElementById('detail-sentiment-score').textContent = stock.sentiment_score;
            const sentimentElement = document.getElementById('detail-sentiment');
            sentimentElement.textContent = stock.sentiment || 'neutral';

            let sentimentClass = 'bg-secondary';
            if (stock.sentiment_score > 0.1) sentimentClass = 'bg-success';
            else if (stock.sentiment_score < -0.1) sentimentClass = 'bg-danger';
            sentimentElement.className = `badge fs-6 ${sentimentClass}`;

            document.getElementById('detail-article-count').textContent = stock.article_count || 0;

            document.getElementById('detail-last-updated').textContent = analysisData.last_updated ?
                new Date(analysisData.last_updated).toLocaleString() : 'N/A';
        }

        function populateHybridAnalysisDetails(stock) {
            // Check if this is a hybrid analysis
            const analysisSource = stock.analysis_source || 'Rule-based';
            const isHybrid = analysisSource.includes('AI + Sentiment') || analysisSource.includes('Fusion');

            if (isHybrid) {
                // Show hybrid analysis section
                document.getElementById('hybrid-analysis-section').style.display = 'block';

                // Populate hybrid details
                document.getElementById('detail-ai-base-score').textContent = stock.ai_base_score || stock.composite_score;
                document.getElementById('detail-sentiment-boost').textContent = stock.sentiment_boost || Math.round(stock.sentiment_score * 100);
                document.getElementById('detail-hybrid-final').textContent = stock.composite_score;
                document.getElementById('detail-fusion-method').textContent = stock.fusion_method || 'AI + Sentiment Fusion';

                // Update analysis source in AI section
                document.getElementById('detail-analysis-source').textContent = 'AI + Sentiment Fusion';
                document.getElementById('detail-analysis-source').className = 'badge bg-success fs-6';
            } else {
                // Hide hybrid analysis section
                document.getElementById('hybrid-analysis-section').style.display = 'none';

                // Update analysis source
                if (analysisSource.includes('AI')) {
                    document.getElementById('detail-analysis-source').textContent = 'AI Analysis';
                    document.getElementById('detail-analysis-source').className = 'badge bg-primary fs-6';
                } else {
                    document.getElementById('detail-analysis-source').textContent = 'Rule-based';
                    document.getElementById('detail-analysis-source').className = 'badge bg-secondary fs-6';
                }
            }
        }

        function populateRSIAnalysis(rsi) {
            document.getElementById('detail-rsi-value').textContent = rsi;

            // RSI Status and Color
            let status, statusClass, barClass, interpretation;

            if (rsi < 30) {
                status = 'Oversold';
                statusClass = 'bg-success';
                barClass = 'bg-success';
                interpretation = 'RSI below 30 indicates oversold conditions. This could be a potential buying opportunity as the stock may be undervalued.';
            } else if (rsi > 70) {
                status = 'Overbought';
                statusClass = 'bg-danger';
                barClass = 'bg-danger';
                interpretation = 'RSI above 70 indicates overbought conditions. The stock may be overvalued and could face selling pressure.';
            } else {
                status = 'Neutral';
                statusClass = 'bg-warning';
                barClass = 'bg-warning';
                interpretation = 'RSI between 30-70 indicates neutral momentum. The stock is neither oversold nor overbought.';
            }

            document.getElementById('detail-rsi-status').textContent = status;
            document.getElementById('detail-rsi-status').className = `badge ${statusClass}`;
            document.getElementById('detail-rsi-bar').style.width = `${rsi}%`;
            document.getElementById('detail-rsi-bar').className = `progress-bar ${barClass}`;
            document.getElementById('detail-rsi-interpretation').textContent = interpretation;
        }

        function populatePromoterHoldings(stock) {
            // Simulated promoter holding data (in real implementation, this would come from API)
            const promoterData = generatePromoterData(stock.symbol_display);

            document.getElementById('detail-promoter-holding').textContent = `${promoterData.holding}%`;

            const trendElement = document.getElementById('detail-promoter-trend');
            trendElement.textContent = promoterData.trend;
            trendElement.className = `badge ${promoterData.trendClass}`;

            document.getElementById('detail-fii-holding').textContent = `${promoterData.fii}%`;
            document.getElementById('detail-dii-holding').textContent = `${promoterData.dii}%`;
            document.getElementById('detail-holding-analysis').textContent = promoterData.analysis;
        }

        function generatePromoterData(symbol) {
            // Simulated data - in real implementation, fetch from financial data API
            const baseHolding = 45 + Math.random() * 30; // 45-75%
            const trends = [
                { trend: 'Increasing', class: 'bg-success', analysis: 'Promoters have been increasing their stake, showing confidence in the company.' },
                { trend: 'Stable', class: 'bg-secondary', analysis: 'Promoter holding remains stable, indicating steady management confidence.' },
                { trend: 'Decreasing', class: 'bg-warning', analysis: 'Slight decrease in promoter holding, monitor for any significant changes.' }
            ];

            const selectedTrend = trends[Math.floor(Math.random() * trends.length)];

            return {
                holding: baseHolding.toFixed(1),
                trend: selectedTrend.trend,
                trendClass: selectedTrend.class,
                fii: (10 + Math.random() * 20).toFixed(1),
                dii: (5 + Math.random() * 15).toFixed(1),
                analysis: selectedTrend.analysis
            };
        }

        function populateNewsAnalysis(stock) {
            // Enhanced news analysis
            const newsData = generateNewsAnalysis(stock);

            document.getElementById('detail-news-sentiment-score').textContent = stock.sentiment_score;

            const newsLabelElement = document.getElementById('detail-news-sentiment-label');
            let newsLabelClass = 'bg-secondary';
            let newsLabel = 'Neutral';

            if (stock.sentiment_score > 0.1) {
                newsLabel = 'Positive';
                newsLabelClass = 'bg-success';
            } else if (stock.sentiment_score < -0.1) {
                newsLabel = 'Negative';
                newsLabelClass = 'bg-danger';
            }

            newsLabelElement.textContent = newsLabel;
            newsLabelElement.className = `badge ${newsLabelClass}`;

            document.getElementById('detail-news-count').textContent = stock.article_count || 0;
            document.getElementById('detail-market-impact').textContent = newsData.impact;
            document.getElementById('detail-news-summary').innerHTML = `<p class="mb-0">${newsData.summary}</p>`;

            // Populate positive factors
            const positiveList = document.getElementById('detail-positive-factors');
            positiveList.innerHTML = newsData.positiveFactors.map(factor =>
                `<li class="text-success"><i class="fas fa-plus-circle"></i> ${factor}</li>`
            ).join('');

            // Populate risk factors
            const riskList = document.getElementById('detail-risk-factors');
            riskList.innerHTML = newsData.riskFactors.map(factor =>
                `<li class="text-danger"><i class="fas fa-exclamation-triangle"></i> ${factor}</li>`
            ).join('');
        }

        function generateNewsAnalysis(stock) {
            // Simulated comprehensive news analysis
            const positiveFactors = [
                'Strong quarterly earnings growth',
                'Expansion into new markets',
                'Positive analyst upgrades',
                'Improved operational efficiency',
                'Strong demand for products/services'
            ];

            const riskFactors = [
                'Regulatory challenges in the sector',
                'Increased competition',
                'Rising input costs',
                'Economic uncertainty',
                'Currency fluctuation risks'
            ];

            const summaries = [
                'Recent news indicates strong operational performance with positive market sentiment. The company has shown resilience in challenging market conditions.',
                'Mixed news flow with both positive developments and some concerns. Overall sentiment remains cautiously optimistic.',
                'Recent announcements suggest strong growth prospects. Management guidance has been positive for the upcoming quarters.',
                'News analysis shows stable business fundamentals with some sector-specific challenges. Long-term outlook remains positive.'
            ];

            return {
                impact: ['High', 'Medium', 'Low'][Math.floor(Math.random() * 3)],
                summary: summaries[Math.floor(Math.random() * summaries.length)],
                positiveFactors: positiveFactors.slice(0, 3 + Math.floor(Math.random() * 2)),
                riskFactors: riskFactors.slice(0, 2 + Math.floor(Math.random() * 2))
            };
        }

        function populateCorporateActions(stock) {
            // Simulated corporate actions data
            const corporateData = generateCorporateActions(stock.symbol_display);

            document.getElementById('detail-dividend-yield').textContent = corporateData.dividendYield;
            document.getElementById('detail-last-dividend').textContent = corporateData.lastDividend;
            document.getElementById('detail-ex-date').textContent = corporateData.exDate;
            document.getElementById('detail-other-actions').innerHTML = corporateData.otherActions;
        }

        function generateCorporateActions(symbol) {
            // Simulated data - in real implementation, fetch from financial data API
            const dividendYield = (Math.random() * 4 + 0.5).toFixed(2); // 0.5-4.5%
            const lastDividend = (Math.random() * 20 + 5).toFixed(0); // ‚Çπ5-25

            const actions = [
                'No recent corporate actions',
                'Stock split 1:2 announced for next quarter',
                'Bonus issue 1:1 declared',
                'Rights issue at ‚Çπ100 per share',
                'Interim dividend of ‚Çπ5 per share declared'
            ];

            return {
                dividendYield: `${dividendYield}%`,
                lastDividend: `‚Çπ${lastDividend}`,
                exDate: new Date(Date.now() - Math.random() * 90 * 24 * 60 * 60 * 1000).toLocaleDateString(),
                otherActions: `<small class="text-info">${actions[Math.floor(Math.random() * actions.length)]}</small>`
            };
        }

        function populateFinancialHighlights(stock) {
            // Simulated financial data
            const financialData = generateFinancialData(stock.symbol_display);

            document.getElementById('detail-revenue-growth').textContent = financialData.revenueGrowth;
            document.getElementById('detail-profit-margin').textContent = financialData.profitMargin;
            document.getElementById('detail-roe').textContent = financialData.roe;
            document.getElementById('detail-debt-equity').textContent = financialData.debtEquity;
            document.getElementById('detail-book-value').textContent = financialData.bookValue;
        }

        function generateFinancialData(symbol) {
            // Simulated data - in real implementation, fetch from financial data API
            const revenueGrowth = (Math.random() * 30 - 5).toFixed(1); // -5% to 25%
            const profitMargin = (Math.random() * 20 + 5).toFixed(1); // 5-25%
            const roe = (Math.random() * 25 + 5).toFixed(1); // 5-30%
            const debtEquity = (Math.random() * 1.5).toFixed(2); // 0-1.5
            const bookValue = (Math.random() * 500 + 100).toFixed(0); // ‚Çπ100-600

            return {
                revenueGrowth: `${revenueGrowth >= 0 ? '+' : ''}${revenueGrowth}%`,
                profitMargin: `${profitMargin}%`,
                roe: `${roe}%`,
                debtEquity: debtEquity,
                bookValue: bookValue
            };
        }

        function populateEnhancedAIAnalysis(stock) {
            // Enhanced AI analysis with investment thesis
            const aiData = generateEnhancedAIAnalysis(stock);

            document.getElementById('detail-reasoning').textContent = aiData.investmentThesis;

            // Populate catalysts
            const catalystsList = document.getElementById('detail-catalysts');
            catalystsList.innerHTML = aiData.catalysts.map(catalyst => `<li>${catalyst}</li>`).join('');

            // Populate risks
            const risksList = document.getElementById('detail-risks');
            risksList.innerHTML = aiData.risks.map(risk => `<li>${risk}</li>`).join('');

            // Overall rating
            const ratingElement = document.getElementById('detail-overall-rating');
            ratingElement.textContent = stock.recommendation;
            let ratingClass = 'bg-secondary';
            if (stock.recommendation === 'BUY') ratingClass = 'bg-success';
            else if (stock.recommendation === 'SELL') ratingClass = 'bg-danger';
            else if (stock.recommendation === 'HOLD') ratingClass = 'bg-warning';
            ratingElement.className = `badge ${ratingClass} fs-5`;

            // Risk level
            const riskElement = document.getElementById('detail-risk-level');
            riskElement.textContent = stock.risk_level || 'Medium';
            let riskClass = 'bg-warning';
            if (stock.risk_level === 'Low') riskClass = 'bg-success';
            else if (stock.risk_level === 'High') riskClass = 'bg-danger';
            riskElement.className = `badge fs-6 ${riskClass}`;

            // Time horizon
            document.getElementById('detail-time-horizon').textContent = aiData.timeHorizon;
        }

        function generateEnhancedAIAnalysis(stock) {
            // Comprehensive AI analysis based on stock data
            const catalysts = [
                'Strong earnings growth trajectory',
                'Market expansion opportunities',
                'Digital transformation initiatives',
                'Cost optimization programs',
                'Strategic partnerships and acquisitions'
            ];

            const risks = [
                'Regulatory changes in the sector',
                'Intense competitive pressure',
                'Economic slowdown impact',
                'Raw material price volatility',
                'Technology disruption risks'
            ];

            const timeHorizons = ['Short Term', 'Medium Term', 'Long Term'];

            let investmentThesis;
            if (stock.composite_score >= 70) {
                investmentThesis = `${stock.symbol_display} presents a compelling investment opportunity with strong fundamentals and positive market sentiment. The company demonstrates solid financial performance and is well-positioned for future growth.`;
            } else if (stock.composite_score >= 50) {
                investmentThesis = `${stock.symbol_display} shows moderate investment potential with balanced risk-reward profile. While there are some positive aspects, investors should monitor key performance indicators closely.`;
            } else {
                investmentThesis = `${stock.symbol_display} faces several challenges that impact its investment attractiveness. Investors should exercise caution and consider the elevated risk factors before making investment decisions.`;
            }

            return {
                investmentThesis: investmentThesis,
                catalysts: catalysts.slice(0, 3 + Math.floor(Math.random() * 2)),
                risks: risks.slice(0, 2 + Math.floor(Math.random() * 2)),
                timeHorizon: timeHorizons[Math.floor(Math.random() * timeHorizons.length)]
            };
        }

        function openYahooFinance() {
            if (currentStockData) {
                const symbol = currentStockData.symbol || currentStockData.symbol_display + '.NS';
                window.open(`https://finance.yahoo.com/quote/${symbol}`, '_blank');
            }
        }

        function refreshStockData() {
            if (currentSector) {
                // Close modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('stockDetailModal'));
                modal.hide();

                // Refresh analysis
                analyzeSector(currentSector);
            }
        }

        function exportStockData() {
            if (currentStockData) {
                const data = {
                    symbol: currentStockData.symbol_display,
                    price: currentStockData.current_price,
                    change: currentStockData.price_change,
                    recommendation: currentStockData.recommendation,
                    score: currentStockData.composite_score,
                    confidence: currentStockData.confidence,
                    sentiment: currentStockData.sentiment_score,
                    market_cap: currentStockData.market_cap,
                    sector: currentStockData.sector,
                    reasoning: currentStockData.reasoning,
                    risk_level: currentStockData.risk_level,
                    exported_at: new Date().toISOString()
                };

                const dataStr = JSON.stringify(data, null, 2);
                const dataBlob = new Blob([dataStr], {type: 'application/json'});
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `${currentStockData.symbol_display}_analysis.json`;
                link.click();
                URL.revokeObjectURL(url);
            }
        }
    </script>
</body>
</html>
